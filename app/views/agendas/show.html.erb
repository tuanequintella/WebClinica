<div class="span12">
  <div class="agenda">
    <% if @agenda.active?  && can?(:read, @agenda) %>
      <table class="table table-bordered table-condensed">
        <thead>
          <tr>
            <th>
              Horário
            </th>
            <% @week.each do |day| %>
              <th class="<%= day.today? ? 'today':'' %>">
                <%= l day, :format => :agenda_day %>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @agenda.time_array(@week).each do |time| %>
            <tr>
              <td>
                <%= l time, :format => :hourly %>
              </td>
              <% @week.each do |day| %>
                <% datetime = day.to_date + time.hour.hours + time.min.minutes %>
                <% if @agenda.appointment_at(datetime).nil? %>
                  <% if datetime < Date.today %>
                    <% if @agenda.available_datetime?(datetime) %>
                      <td> </td>
                    <% else %>
                      <td class="unavailable">
                        <div class="unavailable">
                        </div>
                      </td>
                    <% end %>
                  <% else %>
                    <% if @agenda.available_datetime?(datetime) %>
                      <td>
                        <div class="free-spot" data-date="<%= datetime.to_s %>">
                          <% if can? :create, Appointment %>
                            <%= link_to '#', class: "free-spot-link", title: "Nova cosulta" do %>
                              <i class="icon-plus"></i>
                            <% end %>
                          <% end %>
                        </div>
                      </td>
                    <% else %>
                      <td class="unavailable">
                        <div class="unavailable" data-date="<%= datetime.to_s %>">
                          <% if can? :create, Appointment %>
                            <%= link_to '#', class: "free-spot-link", title: "Consulta fora do horário" do %>
                              <!-- come up with a link that doesn't kill the visual -->
                            <% end %>
                          <% end %>
                        </div>
                      </td>
                    <% end %>
                  <% end %>
                <% else %>
                  <% if @agenda.available_datetime?(datetime) %>
                    <td>
                      <% appointment = @agenda.appointment_at(datetime) %>
                      <div class="busy-spot" data-date="<%= datetime.to_s %>" data-record="<%= appointment.record.id %>">
                        <%= link_to appointment.record.pacient.name, '#', class: "busy-spot-link pull-left", title: "Detalhes" %>
                        <% if datetime >= Date.today && can?(:delete, Appointment) %>
                          <%= link_to appointment_path(appointment), method: :delete, confirm: "Tem certeza que deseja desmarcar essa consulta?", class: "pull-right", title: "Remover" do %>
                            <i class="icon-remove-sign red"></i>
                          <% end %>
                        <% end %>
                      </div>
                    </td>
                  <% else %>
                    <td class="unavailable">
                      <% appointment = @agenda.appointment_at(datetime) %>
                      <div class="unavailable busy-spot" data-date="<%= datetime.to_s %>" data-record="<%= appointment.record.id %>">
                        <%= link_to appointment.record.pacient.name, '#', class: "busy-spot-link pull-left", title: "Detalhes" %>
                        <% if datetime >= Date.today && can?(:delete, Appointment) %>
                          <%= link_to appointment_path(appointment), method: :delete, confirm: "Tem certeza que deseja desmarcar essa consulta?", class: "pull-right", title: "Remover" do %>
                            <i class="icon-remove-sign red"></i>
                          <% end %>
                        <% end %>
                      </div>
                    </td>
                  <% end %>
                <% end %>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      Essa não é uma agenda ativa ou você não tem permissão para vê-la.
    <% end %>
  </div>
</div>

<div id="appointment-window" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Consulta</h3>
  </div>
  <div class="modal-body">
    <%= simple_nested_form_for(Appointment.new, :html => { :class => 'form-horizontal' }) do |f| %>
      <fieldset>        
        <%= f.input :scheduled_at, as: :string, input_html: { readonly: true }%>
        <%= f.association :agenda, :as => :hidden, input_html: { value: @agenda.id } %>
        <%= f.association :record, :include_blank=> "Novo paciente", :label_method => :id_and_pacient %>

        <%= f.fields_for :record do |rec_f| %>
          <%= rec_f.fields_for :pacient do |pac_f| %>
            <%= pac_f.input :name %>
            <%= f.association :health_insurance, :collection => @agenda.doctor.health_insurances, :include_blank => 'Selecione uma opção' %>
            <%= pac_f.input :phone %>
          <% end %>

          <%= rec_f.input :status, collection: Record.status.options, :include_blank => false, :disabled => true, selected: :new %>

          <div id="last_appointment_date" style="display: none">
            <div class="control-group">
              <label for="record_last_appointment_date" class="control-label">
                Última consulta
              </label>
              <div class="controls">
                <%= text_field :record, :last_appointment_date, disabled: true %>
              </div>
            </div>
            <div id="appointment-date-warning" style="display: none">
            </div>
          </div>
        <% end %>
      </fieldset>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancelar</button>
    <%= f.button :submit, 'Salvar consulta', class: "btn btn-primary" %>
  </div>
<% end %>


</div>

<script>
$(function() {
  window.appointmentsBehavior();
});
</script>