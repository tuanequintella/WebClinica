<div class="span12">
  <div class="agenda">
    <% if @agenda.active? %>
      <table class="table table-bordered table-condensed">
        <thead>
          <tr>
            <th>
              Horário
            </th>
            <% @week.each do |day| %>
              <th class="<%= day.today? ? 'today':'' %>">
                <%= l day, :format => :agenda_day %>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @agenda.time_array(@week).each do |time| %>
            <tr>
              <td>
                <%= l time, :format => :hourly %>
              </td>
              <% @week.each do |day| %>
                <% datetime = day.to_date + time.hour.hours + time.min.minutes %>
                <% if not @agenda.available_datetime?(datetime) %>
                  <td class="unavailable">
                    <div class="unavailable">
                    </div>
                  </td>
                <% elsif @agenda.appointment_at(datetime).nil? %>
                  <% if datetime < Date.today %>
                    <td> </td>
                  <% else %>
                    <td>
                      <div class="free-spot" data-date="<%= datetime.to_s %>">
                        <%= link_to '#', class: "free-spot-link", title: "Nova cosulta" do %>
                          <i class="icon-plus"></i>
                        <% end %>
                      </div>
                    </td>
                  <% end %>
                <% else %>
                  <td>
                    <% appointment = @agenda.appointment_at(datetime) %>
                    <div class="busy-spot" data-date="<%= datetime.to_s %>" data-appointment="<% appointment.id %>">
                      <%= link_to appointment.record.pacient.name, '#', class: "busy-spot-link pull-left", title: "Detalhes" %>
                      <% if datetime >= Date.today %>
                        <%= link_to appointment_path(appointment), method: :delete, confirm: "Tem certeza que deseja desmarcar essa consulta?", class: "pull-right", title: "Remover" do %>
                          <i class="icon-remove-sign red"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </td>
                <% end %>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      Essa não é uma agenda ativa
    <% end %>
  </div>
</div>

<%= render partial: 'new_appointment' %>

<script>
  var appointment_date;

  window.bindLinks = function () {
    $("a.free-spot-link").on('click', function () {
        appointment_date = $(this).parent().data('date');
        $("#appointment-form").modal();  
    });
    $("a.busy-spot-link").on('click', function () {
        appointment_date = $(this).parent().data('date');
        $("#appointment-form").modal();
    });
  };

  $('#appointment-form').on('shown', function () {
    $('div#last_appointment_date').hide();
    $('#record_status').val("Sem ficha");
    $('#appointment_scheduled_at').val(appointment_date);
    window.health_insurances = JSON.parse("<%= @agenda.doctor.health_insurances.to_json %>");
    bindRecord();
  });
</script>